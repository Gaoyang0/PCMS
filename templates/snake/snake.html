<!DOCTYPE html>
<HTML>
<HEAD>
	<!-- 描述网页的属性，比如字符编码，引用哪些外部资源-->
	<TITLE>贪吃蛇</TITLE>
	<META CHARSET="utf-8"/>
</HEAD>
<BODY background="" bgcolor="#44FF4E">
    <hr/>
	贪吃蛇<br/><button id="restartBtn">重新开始</button><br/>
    <input id="target_address" style="width: 200px" value="http://127.0.0.1:5000/snake-ai/"/>
    <button id="delayed_test">延时检测</button>
    <button id="ai-start">AI-start</button>
	<hr/>
</BODY>
<script src="/static/js/util.js"></script>
<script src="/static/js/snake_logic.js"></script>
<script src="/static/js/jquery-1.3.2.min.js"></script>
<script>
    var target_address = null;
    document.querySelector('#restartBtn').onclick = function(e) {
        location.reload();
    }
    document.querySelector('#delayed_test').onclick = function(e) {
        target_address = $('#target_address').val();
        ws.send(JSON.stringify({
                'type': 'delayed_test',
                'message': {
                    'target_address': target_address,
                }
        }));
    }
    document.querySelector('#ai-start').onclick = function(e) {
        target_address = $('#target_address').val();
        ws.send(JSON.stringify({
                'type': 'map_data',
                'message': {
                    'body': JSON.parse(JSON.stringify(snake.body)),
                    'food': JSON.parse(JSON.stringify(snake.food)),
                    'direction': JSON.stringify(0),
                    'target_address': target_address,
                    'map_size': {
                        'width': xGridSize,
                        'height': yGridSize,
                    },
                }
        }));
    }

    var ws = null ;

    var target='ws://' + window.location.host + '/ws/test/www/';
    if ('WebSocket' in window) {
        ws = new WebSocket(target);
    } else if ('MozWebSocket' in window) {
        ws = new MozWebSocket(target);
    } else {
        alert('WebSocket is not supported by this browser.');
    }

    ws.onopen = function(obj){

    } ;

    ws.onclose = function (obj) {

    } ;
    ws.onmessage = function(e){
        var data = JSON.parse(e.data);
        var type = data['type'];
        if(type == 'control'){
    	    var keyCode = data['message']['direction'] - 0;
            if(keyCode < 37 || keyCode > 40){
                return;
            }
            if(snake.keyCode){
                if(snake.isValidDir(keyCode)){
                    snake.keyCode = keyCode;
                }
            }else{
                snake.keyCode = keyCode;
                timer = setInterval(function(){
                    snake.move();
                    ws.send(JSON.stringify({
                        'type': 'map_data',
                        'message': {
                            'body': JSON.parse(JSON.stringify(snake.body)),
                            'food': JSON.parse(JSON.stringify(snake.food)),
                            'direction': JSON.stringify(snake.keyCode - 37),
                            'target_address': target_address,
                            'map_size': {
                                'width': xGridSize,
                                'height': yGridSize,
                            },
                        }
                    }));
                }, speed);
                snake.showFood();
            }
        }else if(type == 'delayed_test_result'){
            alert('延时: ' + data['message']['delayed']);
        }
    } ;

</script>
</HTML>